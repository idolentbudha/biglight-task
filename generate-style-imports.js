import { writeFileSync, readFileSync } from "fs";
import { brands, sanitizeBrandName } from "./config.js";

/**
 * Generates brand-specific CSS imports in src/style.css
 * based on BIGLIGHT_BRAND environment variable
 */
function generateStyleImports() {
  const targetBrand = process.env.BIGLIGHT_BRAND;
  const isProduction = process.env.NODE_ENV === "production";

  // In development, always build all brands for theme switching
  // In production, respect BIGLIGHT_BRAND value
  const buildAllBrands = !isProduction || !targetBrand || targetBrand === "all";

  const importsOutputPath = "build/css/imports.css";

  // Generate header and import statements
  let importsContent = `/* Auto-generated by generate-style-imports.js */
/* DO NOT EDIT MANUALLY - regenerated from tokens-custom/figma-tokens.json */
/* Import hierarchy: primitives → responsive → brand files (primitives → alias → mapped) */

`;

  // Add primitive and responsive imports (always included)
  importsContent += `@import "./primitives.css";
@import "./responsive.css";

`;

  // Generate brand import statements
  let brandImports = "";

  if (buildAllBrands) {
    // Development or explicit "all": import all brands
    brands.forEach((brand) => {
      const slug = sanitizeBrandName(brand);
      brandImports += `@import "./${slug}.primitives.css";\n`;
      brandImports += `@import "./${slug}.alias.css";\n`;
      brandImports += `@import "./${slug}.mapped.css";\n`;
    });
  } else {
    // Production with specific brand: import only target brand
    brandImports += `@import "./${targetBrand}.primitives.css";\n`;
    brandImports += `@import "./${targetBrand}.alias.css";\n`;
    brandImports += `@import "./${targetBrand}.mapped.css";\n`;
  }

  // Combine all imports
  importsContent += brandImports;

  // Write the imports file
  writeFileSync(importsOutputPath, importsContent);

  console.log(
    `✅ Generated build/css/imports.css with ${buildAllBrands ? "all brands" : targetBrand} imports`,
  );

  // Generate brand config for JavaScript
  const defaultTheme = buildAllBrands ? "brand-a" : targetBrand;
  const brandConfigContent = `// Auto-generated by generate-style-imports.js
// DO NOT EDIT MANUALLY
export const DEFAULT_BRAND = "${defaultTheme}";
export const IS_MULTI_BRAND = ${buildAllBrands};
`;

  writeFileSync("src/brand-config.js", brandConfigContent);
  console.log(
    `✅ Generated src/brand-config.js with default theme: ${defaultTheme}`,
  );
}

generateStyleImports();
