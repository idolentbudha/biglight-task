import { writeFileSync, readFileSync } from "fs";
import { brands, sanitizeBrandName } from "./config.js";

/**
 * Generates brand-specific CSS imports in src/style.css
 * based on BIGLIGHT_BRAND environment variable
 */
function generateStyleImports() {
  const targetBrand = process.env.BIGLIGHT_BRAND;
  const buildAllBrands = !targetBrand || targetBrand === "all";

  const styleTemplatePath = "src/style.template.css";
  const styleOutputPath = "src/style.css";

  // Read the template
  let template = readFileSync(styleTemplatePath, "utf-8");

  // Generate brand import statements
  let brandImports = "";

  if (buildAllBrands) {
    // Development: import all brands
    brands.forEach((brand) => {
      const slug = sanitizeBrandName(brand);
      brandImports += `@import "../build/css/${slug}.primitives.css";\n`;
      brandImports += `@import "../build/css/${slug}.alias.css";\n`;
      brandImports += `@import "../build/css/${slug}.mapped.css";\n`;
    });
  } else {
    // Production: import only target brand
    brandImports += `@import "../build/css/${targetBrand}.primitives.css";\n`;
    brandImports += `@import "../build/css/${targetBrand}.alias.css";\n`;
    brandImports += `@import "../build/css/${targetBrand}.mapped.css";\n`;
  }

  // Replace the placeholder with generated imports
  const output = template.replace("/* {{BRAND_IMPORTS}} */", brandImports);

  // Write the output file
  writeFileSync(styleOutputPath, output);

  console.log(
    `✅ Generated src/style.css with ${buildAllBrands ? "all brands" : targetBrand} imports`,
  );

  // Generate brand config for JavaScript
  const defaultTheme = buildAllBrands ? "brand-a" : targetBrand;
  const brandConfigContent = `// Auto-generated by generate-style-imports.js
// DO NOT EDIT MANUALLY
export const DEFAULT_BRAND = "${defaultTheme}";
export const IS_MULTI_BRAND = ${buildAllBrands};
`;

  writeFileSync("src/brand-config.js", brandConfigContent);
  console.log(
    `✅ Generated src/brand-config.js with default theme: ${defaultTheme}`,
  );
}

generateStyleImports();
